<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Search - FlightHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('dashboard') }}" class="nav-brand">
                <i class="fas fa-plane-departure"></i>
                FlightHub
            </a>
            <div class="nav-links">
                <a href="{{ url_for('dashboard') }}"><i class="fas fa-th-large"></i> Dashboard</a>
                <a href="{{ url_for('about') }}"><i class="fas fa-info-circle"></i> About</a>
                <a href="{{ url_for('auth.profile') }}" class="user-link">
                    <i class="fas fa-user-circle"></i> {{ user.username }}
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-plane-departure"></i> Flight Search</h1>
            <p>Search and track real-time flights with detailed information</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container" style="padding-top: 40px; padding-bottom: 80px;">
        <!-- Search Section -->
        <section class="search-section">
            <h2>Search Flights</h2>
            <div class="search-grid">
                <div class="input-group">
                    <label for="flight-number"><i class="fas fa-plane"></i> Flight Number (e.g., AA100)</label>
                    <input type="text" id="flight-number" placeholder="AA100">
                </div>
                <div class="input-group">
                    <label for="departure-airport"><i class="fas fa-plane-departure"></i> Departure Airport (IATA)</label>
                    <input type="text" id="departure-airport" placeholder="JFK">
                </div>
                <div class="input-group">
                    <label for="arrival-airport"><i class="fas fa-plane-arrival"></i> Arrival Airport (IATA)</label>
                    <input type="text" id="arrival-airport" placeholder="LAX">
                </div>
                <div class="input-group">
                    <label for="airline-code"><i class="fas fa-tag"></i> Airline Code (IATA)</label>
                    <input type="text" id="airline-code" placeholder="AA">
                </div>
            </div>

            <div class="search-grid-2">
                <div class="input-group">
                    <label for="flight-status"><i class="fas fa-info-circle"></i> Flight Status</label>
                    <select id="flight-status">
                        <option value="">All Statuses</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="active">Active</option>
                        <option value="landed">Landed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="incident">Incident</option>
                        <option value="diverted">Diverted</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary btn-search" onclick="searchFlights()">
                <i class="fas fa-search"></i> Search Flights
            </button>
        </section>

        <!-- Filters & Sort -->
        <section class="controls-section">
            <div class="controls">
                <div class="control-group">
                    <label><i class="fas fa-sort"></i> Sort by:</label>
                    <select id="flight-sort" onchange="sortFlights()">
                        <option value="departure">Departure Time</option>
                        <option value="arrival">Arrival Time</option>
                        <option value="delay">Delay Duration</option>
                        <option value="airline">Airline Name</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><i class="fas fa-filter"></i> Filter Status:</label>
                    <select id="status-filter" onchange="filterFlights()">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="landed">Landed</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="delayed">Delayed Only</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><i class="fas fa-search"></i> Search Results:</label>
                    <input type="text" id="search-box" placeholder="Search results..." oninput="searchInResults()">
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <h2>Flight Results</h2>
            <div id="flights-results" class="results-container">
                <div class="empty-state">
                    <p><i class="fas fa-search"></i> Enter search criteria above to find flights</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading flight data...</p>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 FlightHub. All rights reserved.</p>
        <p>
            <a href="{{ url_for('about') }}"><i class="fas fa-info-circle"></i> About</a> |
            <a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a> |
            <a href="#"><i class="fas fa-file-contract"></i> Terms of Service</a>
        </p>
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;
        let flightsData = [];

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        async function searchFlights() {
            showLoading(true);

            const flightNumber = document.getElementById('flight-number').value.trim();
            const depAirport = document.getElementById('departure-airport').value.trim();
            const arrAirport = document.getElementById('arrival-airport').value.trim();
            const airlineCode = document.getElementById('airline-code').value.trim();
            const flightStatus = document.getElementById('flight-status').value;

            let url = `${API_BASE_URL}/api/flights?`;

            if (flightNumber) url += `flight_iata=${flightNumber}&`;
            if (depAirport) url += `dep_iata=${depAirport}&`;
            if (arrAirport) url += `arr_iata=${arrAirport}&`;
            if (airlineCode) url += `airline_iata=${airlineCode}&`;
            if (flightStatus) url += `flight_status=${flightStatus}&`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    showError('flights-results', data.error.message || 'Failed to fetch flights');
                    flightsData = [];
                } else if (data.data && data.data.length > 0) {
                    flightsData = data.data;
                    displayFlights(flightsData);
                } else {
                    document.getElementById('flights-results').innerHTML = 
                        '<div class="empty-state"><p><i class="fas fa-plane"></i> No flights found. Try different search criteria.</p></div>';
                    flightsData = [];
                }
            } catch (error) {
                showError('flights-results', 'Network error: ' + error.message);
                flightsData = [];
            }

            showLoading(false);
        }

        function displayFlights(flights) {
            const container = document.getElementById('flights-results');

            if (!flights || flights.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No flights to display</p></div>';
                return;
            }

            let html = '';

            flights.forEach(flight => {
                const status = flight.flight_status || 'unknown';
                const delay = flight.departure?.delay || 0;
                const isDelayed = delay > 0;

                html += `
                    <div class="flight-card">
                        <div class="flight-header">
                            <span class="flight-number">
                                <i class="fas fa-plane"></i> ${flight.airline?.name || 'Unknown'} 
                                ${flight.flight?.iata || flight.flight?.number || 'N/A'}
                            </span>
                            <span class="flight-status status-${status}">
                                ${status}
                            </span>
                        </div>

                        <div class="flight-route">
                            <div class="airport-info">
                                <div class="airport-code">${flight.departure?.iata || 'N/A'}</div>
                                <div class="airport-name">${flight.departure?.airport || 'Unknown'}</div>
                            </div>
                            <div class="route-arrow">✈️</div>
                            <div class="airport-info">
                                <div class="airport-code">${flight.arrival?.iata || 'N/A'}</div>
                                <div class="airport-name">${flight.arrival?.airport || 'Unknown'}</div>
                            </div>
                        </div>

                        <div class="flight-details">
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-calendar-alt"></i> Flight Date</span>
                                <span class="detail-value">${flight.flight_date || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-plane-departure"></i> Departure</span>
                                <span class="detail-value">${formatTime(flight.departure?.scheduled)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-plane-arrival"></i> Arrival</span>
                                <span class="detail-value">${formatTime(flight.arrival?.scheduled)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-door-open"></i> Terminal</span>
                                <span class="detail-value">${flight.departure?.terminal || 'N/A'} → ${flight.arrival?.terminal || 'N/A'}</span>
                            </div>
                            ${isDelayed ? `
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-clock"></i> Delay</span>
                                <span class="detail-value">
                                    <span class="delay-badge">${delay} min</span>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function sortFlights() {
            const sortBy = document.getElementById('flight-sort').value;

            if (!flightsData || flightsData.length === 0) return;

            flightsData.sort((a, b) => {
                switch(sortBy) {
                    case 'departure':
                        return new Date(a.departure?.scheduled) - new Date(b.departure?.scheduled);
                    case 'arrival':
                        return new Date(a.arrival?.scheduled) - new Date(b.arrival?.scheduled);
                    case 'delay':
                        return (b.departure?.delay || 0) - (a.departure?.delay || 0);
                    case 'airline':
                        return (a.airline?.name || '').localeCompare(b.airline?.name || '');
                    case 'status':
                        return (a.flight_status || '').localeCompare(b.flight_status || '');
                    default:
                        return 0;
                }
            });

            displayFlights(flightsData);
        }

        function filterFlights() {
            const filter = document.getElementById('status-filter').value;

            if (!flightsData || flightsData.length === 0) return;

            let filtered = flightsData;

            if (filter === 'delayed') {
                filtered = flightsData.filter(f => (f.departure?.delay || 0) > 0);
            } else if (filter !== 'all') {
                filtered = flightsData.filter(f => f.flight_status === filter);
            }

            displayFlights(filtered);
        }

        function searchInResults() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();

            if (!searchTerm) {
                displayFlights(flightsData);
                return;
            }

            const filtered = flightsData.filter(flight => {
                const flightNumber = (flight.flight?.iata || '').toLowerCase();
                const airline = (flight.airline?.name || '').toLowerCase();
                const depAirport = (flight.departure?.airport || '').toLowerCase();
                const arrAirport = (flight.arrival?.airport || '').toLowerCase();

                return flightNumber.includes(searchTerm) || 
                       airline.includes(searchTerm) ||
                       depAirport.includes(searchTerm) ||
                       arrAirport.includes(searchTerm);
            });

            displayFlights(filtered);
        }

        function formatTime(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            } catch (e) {
                return dateString;
            }
        }

        function showError(container, message) {
            const errorHTML = `
                <div class="error-message">
                    <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${message}
                </div>
            `;
            document.getElementById(container).innerHTML = errorHTML;
        }
    </script>
</body>
</html>