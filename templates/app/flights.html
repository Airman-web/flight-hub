<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Search - FlightHub</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-plane-departure"></i>
                <a href="dashboard.html" style="color: inherit; text-decoration: none;">FlightHub</a>
            </div>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-th-large"></i> Dashboard</a>
                <a href="../about.html"><i class="fas fa-info-circle"></i> About</a>
                <a href="../auth/profile.html" class="user-link">
                    <i class="fas fa-user-circle"></i> <span id="username-display">User</span>
                </a>
                <a href="#" onclick="handleLogout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-plane-departure"></i> Flight Search</h1>
            <p>Search and track real-time flights with detailed information</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container" style="padding-top: 40px; padding-bottom: 80px;">
        <!-- Search Section -->
        <section class="search-section">
            <h2>Search Flights</h2>
            <div class="search-grid">
                <div class="input-group">
                    <label for="flight-number"><i class="fas fa-plane"></i> Flight Number (e.g., AA100)</label>
                    <input type="text" id="flight-number" placeholder="AA100">
                </div>
                <div class="input-group">
                    <label for="departure-airport"><i class="fas fa-plane-departure"></i> Departure Airport (IATA)</label>
                    <input type="text" id="departure-airport" placeholder="JFK">
                </div>
                <div class="input-group">
                    <label for="arrival-airport"><i class="fas fa-plane-arrival"></i> Arrival Airport (IATA)</label>
                    <input type="text" id="arrival-airport" placeholder="LAX">
                </div>
                <div class="input-group">
                    <label for="airline-code"><i class="fas fa-tag"></i> Airline Code (IATA)</label>
                    <input type="text" id="airline-code" placeholder="AA">
                </div>
            </div>

            <div class="search-grid-2">
                <div class="input-group">
                    <label for="flight-status"><i class="fas fa-info-circle"></i> Flight Status</label>
                    <select id="flight-status">
                        <option value="">All Statuses</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="active">Active</option>
                        <option value="landed">Landed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="incident">Incident</option>
                        <option value="diverted">Diverted</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary btn-search" onclick="searchFlights()">
                <i class="fas fa-search"></i> Search Flights
            </button>
        </section>

        <!-- Filters & Sort -->
        <section class="controls-section">
            <div class="controls">
                <div class="control-group">
                    <label><i class="fas fa-sort"></i> Sort by:</label>
                    <select id="flight-sort" onchange="sortFlights()">
                        <option value="departure">Departure Time</option>
                        <option value="arrival">Arrival Time</option>
                        <option value="delay">Delay Duration</option>
                        <option value="airline">Airline Name</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><i class="fas fa-filter"></i> Filter Status:</label>
                    <select id="status-filter" onchange="filterFlights()">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="landed">Landed</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="delayed">Delayed Only</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><i class="fas fa-search"></i> Search Results:</label>
                    <input type="text" id="search-box" placeholder="Search results..." oninput="searchInResults()">
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <h2>Flight Results</h2>
            <div id="flights-results" class="results-container">
                <div class="empty-state">
                    <p><i class="fas fa-search"></i> Enter search criteria above to find flights</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading flight data...</p>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p><i class="fas fa-plane"></i> FlightHub - Aviation Intelligence Dashboard</p>
            <p>Flight data powered by <a href="https://aviationstack.com" target="_blank">AviationStack</a> | 
               <i class="fas fa-envelope"></i> Contact: <a href="mailto:e.atigbi@alustudent.com">e.atigbi@alustudent.com</a></p>
            <p>&copy; 2025 FlightHub. All rights reserved.</p>
        </div>
    </footer>

    <style>
        /* ALU Colors - Solid Colors Only */
        body {
            background: #FF6B35;
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: #FF6B35;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-links a:hover {
            color: #FF6B35;
        }

        .btn-logout {
            background: #FF6B35;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .header h1 {
            color: #FF6B35;
        }

        .search-section {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 40px;
            animation: slideInUp 0.6s ease-out;
        }

        .search-section h2 {
            color: #FF6B35;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.9em;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group label i {
            color: #FF6B35;
        }

        .input-group input,
        .input-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #fff5f2;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #FF6B35;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .btn-primary {
            background: #FF6B35;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .btn-search {
            width: 100%;
            padding: 14px;
            font-size: 1.05em;
            font-weight: 600;
            border-radius: 10px;
        }

        .controls-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label i {
            color: #FF6B35;
        }

        .control-group select,
        .control-group input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }

        .results-section {
            margin-top: 40px;
        }

        .results-section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .results-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
            font-size: 1.1em;
        }

        .flight-card {
            border-bottom: 1px solid #f0f0f0;
            padding: 25px;
            transition: all 0.3s ease;
            animation: slideInRight 0.5s ease-out backwards;
        }

        .flight-card:nth-child(1) { animation-delay: 0.1s; }
        .flight-card:nth-child(2) { animation-delay: 0.2s; }
        .flight-card:nth-child(3) { animation-delay: 0.3s; }

        .flight-card:last-child {
            border-bottom: none;
        }

        .flight-card:hover {
            background: #fff5f2;
            transform: translateX(5px);
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .flight-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #FF6B35;
        }

        .flight-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .status-active {
            background: #4CAF50;
        }

        .status-landed {
            background: #2196F3;
        }

        .status-scheduled {
            background: #FF9800;
        }

        .status-cancelled {
            background: #f44336;
        }

        .status-delayed {
            background: #FF5722;
        }

        .flight-route {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .airport-info {
            flex: 1;
            text-align: center;
        }

        .airport-code {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
        }

        .airport-name {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        .route-arrow {
            font-size: 1.8em;
            color: #FF6B35;
            animation: fly 2s ease-in-out infinite;
        }

        @keyframes fly {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            font-size: 0.9em;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: #fff5f2;
            border-radius: 8px;
        }

        .detail-label {
            color: #FF6B35;
            font-size: 0.85em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .delay-badge {
            background: #FF5722;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #c62828;
            animation: slideInDown 0.4s ease-out;
        }

        /* Footer */
        .footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 0px 0px;
            margin-top: 0px;
        }

        .footer p {
            margin: 0px 0;
            color: white;
        }

        .footer a {
            color: #FF6B35;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #5B2C6F;
            text-decoration: underline;
        }

        .footer i {
            margin-right: 5px;
            color: #FF6B35;
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }

            .flight-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .flight-route {
                flex-direction: column;
            }
        }
    </style>

    <script>
        const API_BASE_URL = window.location.origin;
        let flightsData = [];

        // Check authentication
        window.addEventListener('DOMContentLoaded', function() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const userData = JSON.parse(user);
            document.getElementById('username-display').textContent = userData.username || 'User';
        });

        function handleLogout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = '../auth/login.html';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        async function searchFlights() {
            showLoading(true);

            const flightNumber = document.getElementById('flight-number').value.trim();
            const depAirport = document.getElementById('departure-airport').value.trim();
            const arrAirport = document.getElementById('arrival-airport').value.trim();
            const airlineCode = document.getElementById('airline-code').value.trim();
            const flightStatus = document.getElementById('flight-status').value;

            let url = `${API_BASE_URL}/api/flights?`;

            if (flightNumber) url += `flight_iata=${flightNumber}&`;
            if (depAirport) url += `dep_iata=${depAirport}&`;
            if (arrAirport) url += `arr_iata=${arrAirport}&`;
            if (airlineCode) url += `airline_iata=${airlineCode}&`;
            if (flightStatus) url += `flight_status=${flightStatus}&`;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token || ''}`
                    }
                });
                const data = await response.json();

                if (data.error) {
                    showError('flights-results', data.error.message || 'Failed to fetch flights');
                    flightsData = [];
                } else if (data.data && data.data.length > 0) {
                    flightsData = data.data;
                    displayFlights(flightsData);
                } else {
                    document.getElementById('flights-results').innerHTML = 
                        '<div class="empty-state"><p><i class="fas fa-plane"></i> No flights found. Try different search criteria.</p></div>';
                    flightsData = [];
                }
            } catch (error) {
                showError('flights-results', 'Network error: ' + error.message);
                flightsData = [];
            }

            showLoading(false);
        }

        function displayFlights(flights) {
            const container = document.getElementById('flights-results');

            if (!flights || flights.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No flights to display</p></div>';
                return;
            }

            let html = '';

            flights.forEach(flight => {
                const status = flight.flight_status || 'unknown';
                const delay = flight.departure?.delay || 0;
                const isDelayed = delay > 0;

                html += `
                    <div class="flight-card">
                        <div class="flight-header">
                            <span class="flight-number">
                                <i class="fas fa-plane"></i> ${flight.airline?.name || 'Unknown'} 
                                ${flight.flight?.iata || flight.flight?.number || 'N/A'}
                            </span>
                            <span class="flight-status status-${status}">
                                ${status}
                            </span>
                        </div>

                        <div class="flight-route">
                            <div class="airport-info">
                                <div class="airport-code">${flight.departure?.iata || 'N/A'}</div>
                                <div class="airport-name">${flight.departure?.airport || 'Unknown'}</div>
                            </div>
                            <div class="route-arrow">✈️</div>
                            <div class="airport-info">
                                <div class="airport-code">${flight.arrival?.iata || 'N/A'}</div>
                                <div class="airport-name">${flight.arrival?.airport || 'Unknown'}</div>
                            </div>
                        </div>

                        <div class="flight-details">
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-calendar-alt"></i> Flight Date</span>
                                <span class="detail-value">${flight.flight_date || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-plane-departure"></i> Departure</span>
                                <span class="detail-value">${formatTime(flight.departure?.scheduled)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-plane-arrival"></i> Arrival</span>
                                <span class="detail-value">${formatTime(flight.arrival?.scheduled)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-door-open"></i> Terminal</span>
                                <span class="detail-value">${flight.departure?.terminal || 'N/A'} → ${flight.arrival?.terminal || 'N/A'}</span>
                            </div>
                            ${isDelayed ? `
                            <div class="detail-item">
                                <span class="detail-label"><i class="fas fa-clock"></i> Delay</span>
                                <span class="detail-value">
                                    <span class="delay-badge">${delay} min</span>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function sortFlights() {
            const sortBy = document.getElementById('flight-sort').value;

            if (!flightsData || flightsData.length === 0) return;

            flightsData.sort((a, b) => {
                switch(sortBy) {
                    case 'departure':
                        return new Date(a.departure?.scheduled) - new Date(b.departure?.scheduled);
                    case 'arrival':
                        return new Date(a.arrival?.scheduled) - new Date(b.arrival?.scheduled);
                    case 'delay':
                        return (b.departure?.delay || 0) - (a.departure?.delay || 0);
                    case 'airline':
                        return (a.airline?.name || '').localeCompare(b.airline?.name || '');
                    case 'status':
                        return (a.flight_status || '').localeCompare(b.flight_status || '');
                    default:
                        return 0;
                }
            });

            displayFlights(flightsData);
        }

        function filterFlights() {
            const filter = document.getElementById('status-filter').value;

            if (!flightsData || flightsData.length === 0) return;

            let filtered = flightsData;

            if (filter === 'delayed') {
                filtered = flightsData.filter(f => (f.departure?.delay || 0) > 0);
            } else if (filter !== 'all') {
                filtered = flightsData.filter(f => f.flight_status === filter);
            }

            displayFlights(filtered);
        }

        function searchInResults() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();

            if (!searchTerm) {
                displayFlights(flightsData);
                return;
            }

            const filtered = flightsData.filter(flight => {
                const flightNumber = (flight.flight?.iata || '').toLowerCase();
                const airline = (flight.airline?.name || '').toLowerCase();
                const depAirport = (flight.departure?.airport || '').toLowerCase();
                const arrAirport = (flight.arrival?.airport || '').toLowerCase();

                return flightNumber.includes(searchTerm) || 
                       airline.includes(searchTerm) ||
                       depAirport.includes(searchTerm) ||
                       arrAirport.includes(searchTerm);
            });

            displayFlights(filtered);
        }

        function formatTime(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            } catch (e) {
                return dateString;
            }
        }

        function showError(container, message) {
            const errorHTML = `
                <div class="error-message">
                    <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${message}
                </div>
            `;
            document.getElementById(container).innerHTML = errorHTML;
        }
    </script>
</body>
</html>
