<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Live Aircraft Map - FlightHub</title>

        <!-- Leaflet CSS -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
        />

        <!-- MarkerCluster CSS -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"
        />

        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <!-- App CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />

        <script src="{{ url_for('static', filename='js/main.js') }}"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
                background: #f5f5f5;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            }

            /* Navbar */
            .navbar {
                background: white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .nav-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .nav-brand {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 1.4em;
                font-weight: 600;
                color: #2c3e50;
                text-decoration: none;
            }
            
            .nav-brand i {
                color: #FF6B35;
            }

            .nav-logo {
                width: 40px;
                height: 40px;
                border-radius: 8px;
            }

            .nav-links {
                display: flex;
                gap: 20px;
                align-items: center;
            }

            .nav-links a {
                text-decoration: none;
                color: #333;
                font-weight: 600;
                transition: color 0.3s ease;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .nav-links a:hover {
                color: #3498db;
            }

            .btn-logout {
                background: #e74c3c;
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                font-size: 0.9em;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .btn-logout:hover {
                background: #c0392b;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .user-link {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .map-container {
                display: flex;
                height: calc(100vh - 80px);
                position: relative;
            }

            #map {
                flex: 1;
                z-index: 1;
            }

            .map-panel {
                width: 320px;
                background: #ffffff;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
                z-index: 100;
                display: flex;
                flex-direction: column;
                border-left: 1px solid #e0e0e0;
            }

            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .panel-header {
                padding: 20px;
                background: #2c3e50;
                color: white;
                border-bottom: 1px solid #34495e;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .panel-header h3 {
                margin: 0;
                font-size: 1.2em;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .panel-content {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }

            .stat-item {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 3px solid #3498db;
                border: 1px solid #e9ecef;
            }

            .stat-item label {
                display: block;
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
                font-size: 0.9em;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .stat-value {
                font-size: 1.8em;
                color: #2c3e50;
                font-weight: 600;
                margin-top: 5px;
            }

            .stat-item select,
            .stat-item input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-size: 0.9em;
                margin-top: 8px;
                background: white;
                transition: all 0.2s;
            }

            .stat-item select:focus,
            .stat-item input:focus {
                outline: none;
                border-color: #3498db;
                box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            }

            .control-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }

            .control-btn {
                padding: 10px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.85em;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .btn-start {
                background: #4CAF50;
                color: white;
            }

            .btn-start:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            }

            .btn-stop {
                background: #f44336;
                color: white;
            }

            .btn-stop:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
            }

            .btn-center {
                background: #FF6B35;
                color: white;
                grid-column: 1 / -1;
            }

            .btn-center:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            }

            .selected-aircraft {
                background: #FF6B35;
                color: white;
                padding: 15px;
                border-radius: 10px;
                margin-top: 20px;
                display: none;
            }

            .selected-aircraft h4 {
                margin-top: 0;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .selected-aircraft p {
                margin: 5px 0;
                font-size: 0.85em;
                line-height: 1.6;
            }

            .loading-map {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                background: rgba(255, 255, 255, 0.95);
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                z-index: 200;
            }

            .spinner {
                border: 4px solid #f0f0f0;
                border-top: 4px solid #FF6B35;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .aircraft-marker {
                background: none !important;
                border: none !important;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
            }
            
            .aircraft-icon {
                width: 24px;
                height: 24px;
                display: block;
                transform-origin: center center;
            }

            .leaflet-popup-content-wrapper {
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }

            .aircraft-popup {
                font-size: 12px;
                line-height: 1.6;
            }

            .aircraft-popup strong {
                color: #FF6B35;
                font-size: 14px;
            }

            @media (max-width: 768px) {
                .map-panel {
                    position: absolute;
                    width: 280px;
                    height: 100%;
                    right: 0;
                }

                #map {
                    width: 100%;
                }
            }
        </style>
    </head>

    <body>
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <i class="fas fa-plane-departure"></i>
                    <a href="{{ url_for('dashboard') }}" style="color: inherit; text-decoration: none;">FlightHub</a>
                </div>

                <div class="nav-links">
                    <a href="{{ url_for('dashboard') }}"><i class="fas fa-th-large"></i> Dashboard</a>
                    <a href="{{ url_for('about') }}"><i class="fas fa-info-circle"></i> About</a>
                    <a href="{{ url_for('auth.profile') }}" class="user-link">
                        <i class="fas fa-user-circle"></i> {{ user.username }}
                    </a>
                    <a href="{{ url_for('auth.logout') }}" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- Map Container -->
        <div class="map-container">
            <div id="aircraft-loading" class="loading-map" style="display: none;">
                <div class="spinner"></div>
                <div>Loading aircraft...</div>
            </div>

            <!-- Map -->
            <div id="map"></div>

            <!-- Side Panel -->
            <div class="map-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-satellite"></i> Aircraft Tracker</h3>
                </div>

                <div class="panel-content">
                    <div class="stat-item">
                        <label><i class="fas fa-plane"></i> Active Aircraft</label>
                        <div class="stat-value" id="aircraft-count">0</div>
                        <small style="color: #6c757d; font-size: 0.85em;">Real-time tracking</small>
                    </div>

                    <div class="stat-item">
                        <label><i class="fas fa-sync-alt"></i> Update Frequency</label>
                        <select id="update-frequency" onchange="changeUpdateFrequency()">
                            <option value="15000">Every 15 seconds</option>
                            <option value="30000" selected>Every 30 seconds</option>
                            <option value="60000">Every 60 seconds</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.85em; margin-top: 5px; display: block;">OpenSky rate limit: 10s</small>
                    </div>
                    
                    <div class="stat-item" style="background: #e8f4f8; border-left-color: #3498db;">
                        <label><i class="fas fa-info-circle"></i> Legend</label>
                        <div style="font-size: 0.85em; margin-top: 8px; line-height: 1.8;">
                            <div><span style="color: #e74c3c;">‚óè</span> High Altitude (&gt;30k ft)</div>
                            <div><span style="color: #2ecc71;">‚óè</span> Medium Altitude</div>
                            <div><span style="color: #f39c12;">‚óè</span> Low Altitude (&lt;5k ft)</div>
                            <div><span style="color: #95a5a6;">‚óè</span> On Ground</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <!-- Leaflet JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

        <!-- MarkerCluster JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>

        <script>
           // Initialize map
           let map = L.map('map').setView([20, 0], 2);
           L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
           // Use layer group to show all aircraft individually (no clustering)
           let markers = L.layerGroup();
           map.addLayer(markers);

           // Minimum fetch interval (ms) - OpenSky allows 1 request per 10 seconds for anonymous users
           const MIN_INTERVAL = 12000; // 12s to be safe
           let lastFetch = 0;
           let fetchTimeout = null;
           let updateInterval = null;
           let isFetching = false; // Prevent concurrent requests
           let rateLimitedUntil = 0; // Track when we can retry after rate limit

           async function fetchAircraft() {
               const now = Date.now();
               
               // Check if we're rate limited
               if (now < rateLimitedUntil) {
                   const waitTime = Math.ceil((rateLimitedUntil - now) / 1000);
                   console.log(`Rate limited. Waiting ${waitTime} more seconds...`);
                   return;
               }
               
               // Check minimum interval
               if (now - lastFetch < MIN_INTERVAL) {
                   console.log("Skipping fetch - too soon");
                   return;
               }
               
               // Prevent concurrent requests
               if (isFetching) {
                   console.log("Already fetching, skipping...");
                   return;
               }
               
               isFetching = true;
               lastFetch = now;

               try {
                   // Show loading indicator
                   const loadingEl = document.getElementById('aircraft-loading');
                   if (loadingEl) loadingEl.style.display = 'flex';
                   
                   // Wait for map to be ready
                   if (!map || !map.getBounds) {
                       console.log("Map not ready, waiting...");
                       isFetching = false;
                       setTimeout(fetchAircraft, 1000);
                       return;
                   }
                   
                   const bounds = map.getBounds();
                   
                   // Validate bounds before making request
                   if (!bounds || !bounds.isValid() || bounds.getSouth() === bounds.getNorth()) {
                       // Use main endpoint which has better caching
                       console.log("Using /api/aircraft/live (bounds not ready)");
                       const url = `/api/aircraft/live`;
                       const res = await fetch(url);
                       await processAircraftResponse(res);
                       isFetching = false;
                       return;
                   }
                   
                   // Use main endpoint instead of box to avoid rate limits
                   // The main endpoint has caching on the backend
                   console.log("Using /api/aircraft/live (with caching)");
                   const url = `/api/aircraft/live`;
                   const res = await fetch(url);
                   await processAircraftResponse(res);
               } catch (err) {
                   console.error("Error fetching aircraft:", err);
                   const loadingEl = document.getElementById('aircraft-loading');
                   if (loadingEl) loadingEl.style.display = 'none';
                   const countEl = document.getElementById('aircraft-count');
                   if (countEl) countEl.innerText = 'Error';
               } finally {
                   isFetching = false;
               }
           }

           async function processAircraftResponse(res) {
               try {
                   console.log("Processing response, status:", res.status);

                   if (res.status === 429) {
                       // Rate limited - set backoff time (OpenSky allows 1 request per 10 seconds)
                       rateLimitedUntil = Date.now() + 15000; // Wait 15 seconds
                       console.warn("Rate limited! Waiting 15 seconds before next fetch...");
                       
                       const countEl = document.getElementById('aircraft-count');
                       if (countEl) countEl.innerText = 'Rate Limited';
                       
                       const loadingEl = document.getElementById('aircraft-loading');
                       if (loadingEl) loadingEl.style.display = 'none';
                       
                       // Schedule retry after backoff
                       setTimeout(() => {
                           rateLimitedUntil = 0;
                           console.log("Rate limit backoff expired, can fetch again");
                       }, 15000);
                       
                       return;
                   }

                   if (!res.ok) {
                       console.error("Response not OK:", res.status, res.statusText);
                       const errorText = await res.text();
                       console.error("Error response:", errorText);
                       const countEl = document.getElementById('aircraft-count');
                       if (countEl) countEl.innerText = 'Error';
                       const loadingEl = document.getElementById('aircraft-loading');
                       if (loadingEl) loadingEl.style.display = 'none';
                       return;
                   }

                   const data = await res.json();
                   console.log("Response data:", data);
                   
                   // Handle error responses
                   if (data.error || (data.success === false)) {
                       console.error("API Error:", data.error || data.message);
                       const countEl = document.getElementById('aircraft-count');
                       if (countEl) countEl.innerText = '0';
                       const loadingEl = document.getElementById('aircraft-loading');
                       if (loadingEl) loadingEl.style.display = 'none';
                       return;
                   }

                   // API returns aircraft array, not states
                   const aircraft = data.aircraft || [];
                   console.log(`üìä API Response: Found ${aircraft.length} aircraft in response`);
                   
                   if (aircraft.length > 0) {
                       console.log("üìã Sample aircraft data (first 3):", JSON.stringify(aircraft.slice(0, 3), null, 2));
                   }

                   const countEl = document.getElementById('aircraft-count');
                   if (countEl) countEl.innerText = aircraft.length;

                   // Clear all existing markers
                   markers.clearLayers();
                   
                   if (aircraft.length === 0) {
                       console.warn("‚ö†Ô∏è No aircraft in response - check OpenSky API");
                   } else {
                       let validCount = 0;
                       let skippedCount = 0;
                       
                       aircraft.forEach((ac, index) => {
                           // Validate coordinates
                           const lat = parseFloat(ac.latitude);
                           const lon = parseFloat(ac.longitude);
                           
                           if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
                               skippedCount++;
                               if (index < 5) { // Only log first few to avoid spam
                                   console.warn(`‚ö†Ô∏è Aircraft ${index} missing/invalid coordinates:`, ac);
                               }
                               return;
                           }
                           
                           // Validate coordinate ranges
                           if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                               skippedCount++;
                               console.warn(`‚ö†Ô∏è Aircraft ${index} has out-of-range coordinates:`, lat, lon);
                               return;
                           }

                           try {
                               // Get aircraft properties (handle both 'country' and 'origin_country')
                               const country = ac.origin_country || ac.country || 'N/A';
                               const heading = parseFloat(ac.heading) || 0;
                               const altitude = parseFloat(ac.altitude) || 0;
                               const velocity = parseFloat(ac.velocity) || 0;
                               
                               // Determine marker color based on altitude (like OpenSky)
                               let color = '#2ecc71'; // Green (medium altitude)
                               if (altitude > 30000) color = '#e74c3c'; // Red (high altitude)
                               if (altitude < 5000 && altitude > 0) color = '#f39c12'; // Orange (low altitude)
                               if (ac.on_ground) color = '#95a5a6'; // Gray (on ground)
                               
                               // Create SVG airplane icon (like OpenSky) - better visibility
                               const airplaneSVG = `
                                   <svg width="20" height="20" viewBox="0 0 24 24" style="transform: rotate(${heading}deg); transform-origin: 12px 12px;">
                                       <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="${color}" stroke="#ffffff" stroke-width="1"/>
                                   </svg>
                               `;
                               
                               // Create custom airplane icon with rotation
                               const customIcon = L.divIcon({
                                   html: airplaneSVG,
                                   iconSize: [20, 20],
                                   iconAnchor: [10, 10],
                                   className: 'aircraft-marker',
                                   pane: 'markerPane'
                               });
                               
                               const marker = L.marker([lat, lon], { 
                                   icon: customIcon,
                                   zIndexOffset: 1000 // Ensure aircraft appear above map tiles
                               })
                               .bindPopup(`
                                   <div class="aircraft-popup" style="min-width: 200px;">
                                       <strong style="font-size: 14px;">${ac.callsign || ac.icao24 || 'N/A'}</strong><br>
                                       <small>ICAO: ${ac.icao24 || 'N/A'}</small><br>
                                       Country: ${country}<br>
                                       Altitude: ${altitude ? Math.round(altitude) + ' ft' : 'N/A'}<br>
                                       Speed: ${velocity ? Math.round(velocity * 1.94384) + ' knots' : 'N/A'}<br>
                                       Heading: ${heading ? Math.round(heading) + '¬∞' : 'N/A'}<br>
                                       On Ground: ${ac.on_ground ? 'Yes' : 'No'}
                                   </div>
                               `);
                               
                               marker.addTo(markers);
                               validCount++;
                               
                           } catch (markerErr) {
                               console.error(`‚ùå Error creating marker for aircraft ${index}:`, markerErr, ac);
                               skippedCount++;
                           }
                       });
                       
                       // Count markers
                       let markerCount = 0;
                       markers.eachLayer(() => markerCount++);
                       
                       console.log(`‚úÖ Successfully added ${markerCount} aircraft markers to map`);
                       console.log(`   - Valid: ${validCount}, Skipped: ${skippedCount}, Total in response: ${aircraft.length}`);
                       
                       if (markerCount === 0 && aircraft.length > 0) {
                           console.error(`‚ùå ERROR: No markers created despite ${aircraft.length} aircraft in response!`);
                           console.error("   Check coordinate validation and marker creation code.");
                       }
                   }

                   // Hide loading indicator
                   const loadingEl = document.getElementById('aircraft-loading');
                   if (loadingEl) loadingEl.style.display = 'none';
               } catch (err) {
                   console.error("Error processing aircraft response:", err);
                   const loadingEl = document.getElementById('aircraft-loading');
                   if (loadingEl) loadingEl.style.display = 'none';
                   const countEl = document.getElementById('aircraft-count');
                   if (countEl) countEl.innerText = 'Error';
               }
           }

           // Wait for map to be fully loaded before starting
           map.whenReady(() => {
               console.log("Map is ready, starting aircraft fetch");
               
               // Initial fetch after a short delay to ensure map is ready
               setTimeout(() => {
                   fetchAircraft();
               }, 500);
               
               // Set up interval update
               const frequencyEl = document.getElementById("update-frequency");
               if (frequencyEl) {
                   updateInterval = setInterval(fetchAircraft, Math.max(parseInt(frequencyEl.value) || 10000, MIN_INTERVAL));
               }
               
               // Debounce fetch on map move - use longer delay to avoid rate limits
               map.on("moveend", () => {
                   if (fetchTimeout) clearTimeout(fetchTimeout);
                   // Wait longer before fetching after map move to avoid rate limits
                   fetchTimeout = setTimeout(() => {
                       const now = Date.now();
                       if (now >= rateLimitedUntil && now - lastFetch >= MIN_INTERVAL) {
                           fetchAircraft();
                       }
                   }, Math.max(MIN_INTERVAL, 5000)); // Wait at least 5 seconds after map move
               });
           });

           function changeUpdateFrequency() {
               if (updateInterval) clearInterval(updateInterval);
               const frequencyEl = document.getElementById("update-frequency");
               if (frequencyEl) {
                   const chosen = parseInt(frequencyEl.value) || 10000;
                   // Ensure minimum interval is respected
                   const actualInterval = Math.max(chosen, MIN_INTERVAL);
                   updateInterval = setInterval(() => {
                       const now = Date.now();
                       if (now >= rateLimitedUntil && now - lastFetch >= MIN_INTERVAL && !isFetching) {
                           fetchAircraft();
                       }
                   }, actualInterval);
                   console.log(`Update frequency changed to ${actualInterval}ms (minimum: ${MIN_INTERVAL}ms)`);
               }
           }
        </script>
    </body>
</html>
